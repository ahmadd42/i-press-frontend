<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- SEO Meta Tags -->
  <meta name="description" content="">
  <meta name="keywords" content="">
  <meta name="author" content="">

  <!-- Open Graph / Facebook -->
  <meta property="og:title" content="">
  <meta property="og:description" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <!-- Twitter -->
  <meta name="twitter:card" content="">
  <meta name="twitter:title" content="">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="">

  <link rel="stylesheet" href="styling/landing-page.css">
  <link rel="stylesheet" href="styling/landing-page-mobile.css">

  <script>
    function getElapsedTime(GivenDatetime) {
      var msg = "";
	const now = new Date();
const givenDate = new Date(GivenDatetime);  // your given date-time

const diffMs = now - givenDate;  // difference in milliseconds

// Convert milliseconds to more useful units:
const diffSeconds = Math.floor(diffMs / 1000);
const diffMinutes = Math.floor(diffMs / (1000 * 60));
const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
const diffMonths = Math.floor(diffMs / (1000 * 60 * 60 * 24 * 30));
const diffYears = (diffMonths / 12).toFixed(1);

if(diffMinutes <= 60) { msg = diffMinutes + " minute" + (diffMinutes > 1 ? "s" : "") + " ago"; }
else if(diffHours <= 24) { msg = diffHours + " hour" + (diffHours > 1 ? "s" : "") + " ago"; }
else if(diffDays <= 30) { msg = diffDays + " day" + (diffDays > 1 ? "s" : "") + " ago"; }
else if(diffMonths <= 12) { msg = diffMonths + " month" + (diffMonths > 1 ? "s" : "") + " ago"; }
else { msg = diffYears + " year" + (diffYears > 1 ? "s" : "") + " ago"; }

return msg;

    }

  </script>

  <title>IPress - The knowledge sharing platform</title>
</head>
<body>
<div id="container">
</div>
<script>

const screen = (window.innerWidth < 1000) ? "small" : "big";

function loadTemplateAndFeeds() {
  const con = document.getElementById("container");

let template = (window.innerWidth < 1000)
        ? "small-main.html"
        : "big-main.html";
if(window.innerWidth < 800) {        

    fetch("small-main.html")
        .then(res => res.text())
        .then(html => {
            con.innerHTML = html;   // Template is now in place
            getSigninStatus();
            fetchFeeds();
        });
      }

else {
      fetch("big-main.html")
        .then(res => res.text())
        .then(html => {
            con.innerHTML = html;   // Template is now in place
            getSigninStatus();
            fetchFeeds();
        });
}
}

function goShare() {
    if(localStorage.getItem("userId"))  {
    if(window.innerWidth < 800)
      window.location.href = "users/share-s.html";
    else
      window.location.href = "users/share.html";
  }
}
async function fetchFeeds() {
  const container = document.getElementById('doc-panel');
  try {
    //const response = await fetch("http://localhost:3000/files/getfeeds", {
    const response = await fetch("https://i-press-backend-production.up.railway.app/files/getfeeds", {      
    method: "POST",
      });

  if (!response.ok) {
    throw new Error("Sorry ! Could not fetch your feeds.");
      }

  const data = await response.json(); // JSONPlaceholder returns an array
    
  for(let record of data) {
    const elapsedTime = getElapsedTime(record.SharedOn);
    const isTruncated = record.Description.length > 150;
    const shortText = record.Description.slice(0, 150);
    const conURL = `https://i-press-backend-production.up.railway.app/files/getContent/${record.ContentID}${record.Extension}/${screen}`;

  const div = document.createElement('div');
  div.className = (screen === "big") ? 'doc-item' : 'doc-item-mobile';
  var HTMLString = '';
          if(record.Extension === ".pdf") {
          let prevURL = `https://i-press-backend-production.up.railway.app/files/getContent/${record.ContentID}.jpg/${screen}`;
          let exists = await resourceExists(prevURL);

          if(exists === false) {
          HTMLString += (screen === "big") 
                        ? `<div class="doc-img"><div class="username"><p class="grid-text uploader">PDF Document</p></div><div class="content-icon" style="background-image: url('graphics/pdf-icon.jpg');"></div>` 
                        : `<div class="doc-img-mobile"><div class="username"><p class="grid-text uploader">PDF Document</p></div><div class="content-icon-mobile" style="background-image: url('graphics/pdf-icon.jpg');"></div>`;
          }
          else {
          HTMLString += (screen === "big") 
                        ? `<div class="doc-img"><div class="username"><p class="grid-text uploader">PDF Document</p></div><div class="content-icon"><img src='${prevURL}' /></div>` 
                        : `<div class="doc-img-mobile"><div class="username"><p class="grid-text uploader">PDF Document</p></div><div class="content-icon-mobile"><img src='${prevURL}' /></div>`;
          }                        
          }
          else if(record.Extension === ".jpg" || record.Extension === ".jpeg" || record.Extension === ".gif" || record.Extension === ".png" || record.Extension === ".tiff") {
                HTMLString += (screen === "big") 
                              ? `<div class="doc-img"><div class="username"><p class="grid-text uploader">Image</p></div><div class="content-icon"><img src='${conURL}' /></div>` 
                              : `<div class="doc-img-mobile"><div class="username"><p class="grid-text uploader">Image</p></div><div class="content-icon"><img src='${conURL}' /></div>`;
          }
          else if(record.Extension === ".mp3" || record.Extension === ".mp4" || record.Extension === ".mpeg") {
            //const prevURL = `https://i-press-backend-production.up.railway.app/files/getContent/${record.ContentID}${record.Extension}`;
            HTMLString += (screen === "big")
                          ? `<div class="video-prev-container"><div class="username"><p class="grid-text uploader">MP4 Video</p></div><video class="video-prev" playbackRate=1.4 loop muted playsinline preload="metadata" oncontextmenu="return false"><source src="${conURL}" type="video/mp4"></video>`
                          : `<div class="video-prev-container-mobile"><div class="username"><p class="grid-text uploader">MP4 Video</p></div><video class="video-prev-mobile" playbackRate=1.4 loop muted playsinline preload="metadata" oncontextmenu="return false"><source src="${conURL}" type="video/mp4"></video>`;  
          }
          HTMLString += `<div class="username"><p class="grid-text uploader">${record.UserID}</p></div></div>`;

        if(record.Extension === ".mp3" || record.Extension === ".mp4" || record.Extension === ".mpeg") {        
          HTMLString += `<div class="video-desc">`;
          }
          else {
          HTMLString += `<div class="doc-desc">`;
          }
          HTMLString += `<div><a href="view?id=${record.ContentID}"><p class="grid-text title"><b>${record.DocumentTitle}</b></p></a></div>
          <div><span class="descr">
            ${isTruncated ? shortText + '...' : record.Description}
            </span>
            ${isTruncated ? '<a href="#" class="toggle-link">Read more</a>' : ''}
            </div>
          <div><p class="grid-text"><b>Author: </b>${record.Author}</p></div>
          <div><p class="grid-text"><b>Shared: </b>${elapsedTime}</p></div>
        </div>`

        div.innerHTML = HTMLString;
          
    if (isTruncated) {
    const toggleLink = div.querySelector('.toggle-link');
    const textSpan = div.querySelector('.descr');

    toggleLink.addEventListener('click', function (e) {
      e.preventDefault();
      textSpan.style.opacity = 0;
      toggleLink.style.opacity = 0;
      setTimeout(() => {
      const isExpanded = toggleLink.textContent === 'Read less';
      textSpan.textContent = isExpanded ? shortText + '...' : record.Description;
      toggleLink.textContent = isExpanded ? 'Read more' : 'Read less';
      textSpan.style.opacity = 1;
      toggleLink.style.opacity = 1;
      }, 200); // match the transition 

    });
  }

  /// Code to play video preview on mouse over
const previewVideo = (screen === "big") ? div.querySelector(".video-prev") : div.querySelector(".video-prev-mobile");

if(previewVideo) {

previewVideo.playbackRate = 1.5;
let lastTime = 0; // store the last playback position

// On hover → start playing preview from last stopped time
previewVideo.parentElement.addEventListener("mouseenter", () => {
  previewVideo.currentTime = lastTime;
  //previewVideo.loop = true;
  previewVideo.play().catch(console.error);
});

// On mouse leave → pause and remember last stopped frame
previewVideo.parentElement.addEventListener("mouseleave", () => {
  lastTime = previewVideo.currentTime; // save position
  previewVideo.pause();
  previewVideo.currentTime = 0;
});
}

  container.appendChild(div);

    }
  }
catch (error) {
        //alert(error);
        console.log("Error fetching data:", error);
        document.getElementById("doc-panel").innerHTML = "<div class=\"error-div\">Couldn't fetch your feeds</div>";
        }        
    }

function getSigninStatus() {
  const profile_area = document.getElementById("profile");
  const display_name = localStorage.getItem("displayName");
  if (display_name) {
    profile_area.className = "me";
    profile_area.innerHTML = `<button id="profile_btn">Me</button>`;
    document.getElementById("disp_name").innerHTML = display_name;  
  }
  else {
    if(screen === "big") profile_area.className = "signin"; else profile_area.className = "profile-mobile";
    profile_area.innerHTML = `<a href="users/login.html">Sign in or create your account to get personalized feeds, and to upload and engage with the content</a>`;
  }
}

function signOut() {
  localStorage.clear();
  getSigninStatus();
}    

async function resourceExists(url) {
  try {
    const response = await fetch(url, { method: "HEAD" });
    return response.ok;
  } catch (err) {
    return false;
  }
}

window.onclick = function(event) {
  const profile_area = document.getElementById("profile");
  profile_btn = document.getElementById("profile_btn");
  topmenu = document.getElementById("top-menu");
  const menu_btn = document.getElementById("menu-btn");
  const side_nav = document.getElementById("side-nav");

  if(menu_btn && event.target === menu_btn) {
//    if(side_nav.style.display === "none") side_nav.style.display = "block"; else side_nav.style.display = "none";
side_nav.classList.toggle("active");
  }
  else if (event.target === profile_area || event.target === profile_btn ) {
    topmenu.style.opacity = 1;
  }
  else if(topmenu.style.opacity == 1) {
    topmenu.style.opacity = 0;
  }
};

window.addEventListener("storage", function (event) {
getSigninStatus();
});

window.addEventListener("DOMContentLoaded", loadTemplateAndFeeds);

    </script>

</body>
</html>